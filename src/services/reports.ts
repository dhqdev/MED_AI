import type { UserProgress } from '../contexts/AuthContext';

export interface PerformanceReport {
  overallAccuracy: number;
  totalQuestions: number;
  weakSpecialties: Array<{
    name: string;
    accuracy: number;
    questionsAnswered: number;
    recommendations: string[];
  }>;
  strongSpecialties: Array<{
    name: string;
    accuracy: number;
    questionsAnswered: number;
  }>;
  recentTrends: {
    improvementAreas: string[];
    concernAreas: string[];
  };
  recommendedActions: string[];
  nextSteps: string[];
}

export interface AutoGeneratedMaterial {
  id: string;
  title: string;
  specialty: string;
  type: 'resumo' | 'exercicio' | 'video' | 'flashcard';
  priority: 'urgent' | 'high' | 'medium' | 'low';
  reason: string;
  content: {
    topics: string[];
    estimatedTime: string;
    difficulty: 'easy' | 'medium' | 'hard';
  };
  triggerReason: string; // Por que foi gerado automaticamente
}

/**
 * Gera relatÃ³rio de performance automaticamente
 */
export function generatePerformanceReport(progress: UserProgress): PerformanceReport {
  const specialtyStats = Object.entries(progress.specialties).map(([name, stats]) => ({
    name,
    accuracy: stats.total > 0 ? (stats.correct / stats.total) * 100 : 0,
    total: stats.total,
    correct: stats.correct,
  }));

  // Especialidades fracas (< 70% de acerto e pelo menos 5 questÃµes)
  const weakSpecialties = specialtyStats
    .filter(s => s.total >= 5 && s.accuracy < 70)
    .sort((a, b) => a.accuracy - b.accuracy)
    .map(s => ({
      name: s.name,
      accuracy: s.accuracy,
      questionsAnswered: s.total,
      recommendations: generateRecommendations(s.accuracy, s.total),
    }));

  // Especialidades fortes (â‰¥ 80% de acerto)
  const strongSpecialties = specialtyStats
    .filter(s => s.total >= 5 && s.accuracy >= 80)
    .sort((a, b) => b.accuracy - a.accuracy)
    .map(s => ({
      name: s.name,
      accuracy: s.accuracy,
      questionsAnswered: s.total,
    }));

  // AnÃ¡lise de tendÃªncias recentes (Ãºltimas 10 questÃµes)
  const recentQuestions = progress.questionHistory.slice(-10);
  const recentAccuracy = recentQuestions.length > 0
    ? (recentQuestions.filter(q => q.correct).length / recentQuestions.length) * 100
    : 0;

  const overallAccuracy = progress.totalQuestions > 0
    ? (progress.correctAnswers / progress.totalQuestions) * 100
    : 0;

  const improvementAreas: string[] = [];
  const concernAreas: string[] = [];

  // Detectar Ã¡reas de melhoria ou preocupaÃ§Ã£o
  if (recentAccuracy > overallAccuracy + 10) {
    improvementAreas.push('Desempenho recente melhorando significativamente');
  } else if (recentAccuracy < overallAccuracy - 10) {
    concernAreas.push('Desempenho recente em queda - considere revisar conceitos bÃ¡sicos');
  }

  weakSpecialties.forEach(ws => {
    if (ws.accuracy < 50) {
      concernAreas.push(`${ws.name}: Desempenho crÃ­tico (${ws.accuracy.toFixed(0)}%)`);
    } else if (ws.accuracy < 70) {
      concernAreas.push(`${ws.name}: Requer atenÃ§Ã£o (${ws.accuracy.toFixed(0)}%)`);
    }
  });

  // AÃ§Ãµes recomendadas
  const recommendedActions = generateRecommendedActions(
    weakSpecialties,
    progress
  );

  // PrÃ³ximos passos
  const nextSteps = generateNextSteps(weakSpecialties);

  return {
    overallAccuracy,
    totalQuestions: progress.totalQuestions,
    weakSpecialties,
    strongSpecialties,
    recentTrends: {
      improvementAreas,
      concernAreas,
    },
    recommendedActions,
    nextSteps,
  };
}

/**
 * Gera recomendaÃ§Ãµes especÃ­ficas para uma especialidade
 */
function generateRecommendations(
  accuracy: number,
  total: number
): string[] {
  const recommendations: string[] = [];

  if (accuracy < 50) {
    recommendations.push('ðŸš¨ URGENTE: Revisar conceitos fundamentais');
    recommendations.push('ðŸ“š Estudar material bÃ¡sico antes de tentar questÃµes');
    recommendations.push('ðŸ‘¨â€ðŸ« Considerar ajuda de um mentor ou professor');
  } else if (accuracy < 60) {
    recommendations.push('âš ï¸ ReforÃ§ar conceitos bÃ¡sicos');
    recommendations.push('ðŸ“– Fazer resumos dos principais tÃ³picos');
    recommendations.push('ðŸ’¡ Resolver questÃµes comentadas');
  } else if (accuracy < 70) {
    recommendations.push('ðŸ“Š Identificar pontos especÃ­ficos de dificuldade');
    recommendations.push('ðŸŽ¯ Praticar com questÃµes de nÃ­vel mÃ©dio');
    recommendations.push('ðŸ”„ Revisar erros anteriores');
  }

  if (total < 10) {
    recommendations.push('ðŸ“ˆ Responder mais questÃµes para melhor anÃ¡lise');
  }

  return recommendations;
}

/**
 * Gera aÃ§Ãµes recomendadas gerais
 */
function generateRecommendedActions(
  weakSpecialties: PerformanceReport['weakSpecialties'],
  progress: UserProgress
): string[] {
  const actions: string[] = [];

  // Baseado em especialidades fracas
  if (weakSpecialties.length > 0) {
    actions.push(`Focar nos prÃ³ximos 7 dias em: ${weakSpecialties.slice(0, 3).map(w => w.name).join(', ')}`);
    actions.push('Dedicar pelo menos 1 hora diÃ¡ria Ã s especialidades com dificuldade');
  }

  // Baseado em metas
  const dailyGoal = progress.goals?.dailyQuestions || 10;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const todayQuestions = progress.questionHistory?.filter(q => {
    const qDate = new Date(q.timestamp);
    qDate.setHours(0, 0, 0, 0);
    return qDate.getTime() === today.getTime();
  }).length || 0;

  if (todayQuestions < dailyGoal) {
    actions.push(`Completar meta diÃ¡ria: faltam ${dailyGoal - todayQuestions} questÃµes hoje`);
  }

  // Baseado em streak
  if (progress.streakDays < 7) {
    actions.push('Manter consistÃªncia: estudar todos os dias para criar o hÃ¡bito');
  } else {
    actions.push(`Manter streak atual de ${progress.streakDays} dias! Continue assim!`);
  }

  // DiversificaÃ§Ã£o
  const specialtiesStudied = Object.keys(progress.specialties).length;
  if (specialtiesStudied < 5) {
    actions.push('Diversificar estudos: explorar novas especialidades');
  }

  return actions;
}

/**
 * Gera prÃ³ximos passos personalizados
 */
function generateNextSteps(
  weakSpecialties: PerformanceReport['weakSpecialties']
): string[] {
  const steps: string[] = [];

  if (weakSpecialties.length > 0) {
    const weakest = weakSpecialties[0];
    steps.push(`1. Estudar material bÃ¡sico de ${weakest.name}`);
    steps.push(`2. Resolver 10 questÃµes fÃ¡ceis de ${weakest.name}`);
    steps.push(`3. Revisar erros e fazer anotaÃ§Ãµes`);
    
    if (weakSpecialties.length > 1) {
      const secondWeakest = weakSpecialties[1];
      steps.push(`4. Iniciar revisÃ£o de ${secondWeakest.name}`);
    }
  } else {
    steps.push('1. Explorar novas especialidades');
    steps.push('2. Aumentar nÃ­vel de dificuldade das questÃµes');
    steps.push('3. Resolver casos clÃ­nicos complexos');
  }

  steps.push('5. Revisar material de estudo gerado automaticamente');
  steps.push('6. Manter rotina diÃ¡ria de estudos');

  return steps;
}

/**
 * Gera materiais automaticamente baseado em dificuldades detectadas
 */
export function autoGenerateMaterials(progress: UserProgress): AutoGeneratedMaterial[] {
  const materials: AutoGeneratedMaterial[] = [];
  const report = generatePerformanceReport(progress);

  // Para cada especialidade fraca, gerar materiais
  report.weakSpecialties.forEach((weak, index) => {
    const urgency = weak.accuracy < 50 ? 'urgent' : weak.accuracy < 60 ? 'high' : 'medium';

    // Material 1: Resumo bÃ¡sico
    materials.push({
      id: `auto-resumo-${weak.name}-${Date.now()}-${index}`,
      title: `RevisÃ£o Essencial: ${weak.name}`,
      specialty: weak.name,
      type: 'resumo',
      priority: urgency,
      reason: `Desempenho em ${weak.name}: ${weak.accuracy.toFixed(0)}% de acerto`,
      content: {
        topics: [
          'Conceitos fundamentais',
          'Fisiopatologia bÃ¡sica',
          'Quadro clÃ­nico tÃ­pico',
          'DiagnÃ³stico diferencial',
          'Abordagem terapÃªutica inicial',
        ],
        estimatedTime: '45 min',
        difficulty: 'easy',
      },
      triggerReason: `Gerado automaticamente devido ao desempenho abaixo de 70% (${weak.accuracy.toFixed(0)}%)`,
    });

    // Material 2: ExercÃ­cios dirigidos
    materials.push({
      id: `auto-exercicio-${weak.name}-${Date.now()}-${index}`,
      title: `ExercÃ­cios PrÃ¡ticos: ${weak.name}`,
      specialty: weak.name,
      type: 'exercicio',
      priority: urgency === 'urgent' ? 'high' : 'medium',
      reason: 'PrÃ¡tica necessÃ¡ria para fixaÃ§Ã£o',
      content: {
        topics: [
          '20 questÃµes progressivas',
          'ExplicaÃ§Ã£o detalhada de cada resposta',
          'Dicas e macetes',
        ],
        estimatedTime: '60 min',
        difficulty: weak.accuracy < 50 ? 'easy' : 'medium',
      },
      triggerReason: `Criado para reforÃ§ar conhecimentos em ${weak.name}`,
    });

    // Material 3: Flashcards (se muito crÃ­tico)
    if (weak.accuracy < 60) {
      materials.push({
        id: `auto-flashcard-${weak.name}-${Date.now()}-${index}`,
        title: `Flashcards: Conceitos-chave de ${weak.name}`,
        specialty: weak.name,
        type: 'flashcard',
        priority: 'high',
        reason: 'MemorizaÃ§Ã£o ativa de conceitos essenciais',
        content: {
          topics: [
            '50 flashcards com conceitos fundamentais',
            'Perguntas e respostas diretas',
            'RevisÃ£o espaÃ§ada',
          ],
          estimatedTime: '20 min/dia',
          difficulty: 'easy',
        },
        triggerReason: `Performance crÃ­tica detectada: ${weak.accuracy.toFixed(0)}%`,
      });
    }
  });

  // Materiais para Ã¡reas de melhoria recente
  if (report.recentTrends.concernAreas.length > 0) {
    materials.push({
      id: `auto-alerta-${Date.now()}`,
      title: 'RevisÃ£o Geral: ReforÃ§o de Conceitos',
      specialty: 'Multidisciplinar',
      type: 'resumo',
      priority: 'high',
      reason: 'Queda de desempenho recente detectada',
      content: {
        topics: [
          'RevisÃ£o dos erros mais frequentes',
          'Conceitos que costumam confundir',
          'EstratÃ©gias de prova',
        ],
        estimatedTime: '30 min',
        difficulty: 'medium',
      },
      triggerReason: 'Sistema detectou queda no desempenho recente',
    });
  }

  // Se o aluno estÃ¡ indo bem, sugerir desafios
  if (report.strongSpecialties.length >= 3 && report.weakSpecialties.length === 0) {
    const topSpecialty = report.strongSpecialties[0];
    materials.push({
      id: `auto-desafio-${Date.now()}`,
      title: `Casos Complexos: ${topSpecialty.name}`,
      specialty: topSpecialty.name,
      type: 'video',
      priority: 'medium',
      reason: `Excelente desempenho em ${topSpecialty.name} (${topSpecialty.accuracy.toFixed(0)}%)`,
      content: {
        topics: [
          'Casos clÃ­nicos avanÃ§ados',
          'DiscussÃ£o de diagnÃ³sticos diferenciais',
          'Tomada de decisÃ£o complexa',
        ],
        estimatedTime: '40 min',
        difficulty: 'hard',
      },
      triggerReason: `Criado para desafiar: performance acima de 80%`,
    });
  }

  return materials.sort((a, b) => {
    const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
    return priorityOrder[a.priority] - priorityOrder[b.priority];
  });
}

/**
 * Verifica se deve gerar novos materiais automaticamente
 */
export function shouldGenerateNewMaterials(progress: UserProgress): boolean {
  // Gerar a cada 10 questÃµes
  return progress.totalQuestions > 0 && progress.totalQuestions % 10 === 0;
}

/**
 * Formata o relatÃ³rio para exibiÃ§Ã£o
 */
export function formatReportForDisplay(report: PerformanceReport): string {
  let text = '# ðŸ“Š RelatÃ³rio de Performance\n\n';
  
  text += `**Aproveitamento Geral:** ${report.overallAccuracy.toFixed(1)}%\n`;
  text += `**Total de QuestÃµes:** ${report.totalQuestions}\n\n`;
  
  if (report.weakSpecialties.length > 0) {
    text += '## âš ï¸ Especialidades que Precisam de AtenÃ§Ã£o\n\n';
    report.weakSpecialties.forEach(ws => {
      text += `### ${ws.name} - ${ws.accuracy.toFixed(0)}%\n`;
      text += `QuestÃµes: ${ws.questionsAnswered}\n`;
      text += 'RecomendaÃ§Ãµes:\n';
      ws.recommendations.forEach(rec => {
        text += `- ${rec}\n`;
      });
      text += '\n';
    });
  }
  
  if (report.strongSpecialties.length > 0) {
    text += '## âœ… Especialidades com Bom Desempenho\n\n';
    report.strongSpecialties.forEach(ss => {
      text += `- **${ss.name}**: ${ss.accuracy.toFixed(0)}% (${ss.questionsAnswered} questÃµes)\n`;
    });
    text += '\n';
  }
  
  if (report.recentTrends.concernAreas.length > 0) {
    text += '## ðŸ” Pontos de AtenÃ§Ã£o\n\n';
    report.recentTrends.concernAreas.forEach(area => {
      text += `- ${area}\n`;
    });
    text += '\n';
  }
  
  if (report.recommendedActions.length > 0) {
    text += '## ðŸŽ¯ AÃ§Ãµes Recomendadas\n\n';
    report.recommendedActions.forEach((action, i) => {
      text += `${i + 1}. ${action}\n`;
    });
    text += '\n';
  }
  
  if (report.nextSteps.length > 0) {
    text += '## ðŸ“‹ PrÃ³ximos Passos\n\n';
    report.nextSteps.forEach(step => {
      text += `${step}\n`;
    });
  }
  
  return text;
}
